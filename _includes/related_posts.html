{%- if site.posts.size > 1 -%}
    <h2>Related posts</h2>
{%- endif -%}

{%- assign maxRelated = 3 -%}
{%- assign relatedCount = 0 -%}

{%- assign minTags = 2 -%}

<!-- Look for posts with at least minTags tags in common -->
{%- for post in site.posts -%}
  {%- if relatedCount < maxRelated and page.url != post.url -%}
    {%- assign sharedTags = 0 -%}
    {%- for tag in post.tags -%}
      {%- if page.tags contains tag -%}
        {%- assign sharedTags = sharedTags | plus: 1 -%}
        {%- if sharedTags == minTags -%}{%- break -%}{%- endif -%}
      {%- endif -%}
    {%- endfor -%}

    {%- if sharedTags >= minTags -%}
      {% include post_title.html %}
      {%- assign relatedCount = relatedCount | plus: 1 -%}
      {%- if relatedCount == maxRelated -%}{%- break -%}{%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}
{%- if relatedCount == maxRelated -%}{%- break -%}{%- endif -%}

<!-- If there aren't enough, pick recent posts from the same category,
as long as they don't have more than minTags shared tags -->
{%- if relatedCount < maxRelated -%}
  {%- for post in site.posts -%}
    {%- if relatedCount < maxRelated and page.url != post.url and page.category == post.category -%}
      {%- assign sharedTags = 0 -%}
      {%- for tag in post.tags -%}
        {%- if page.tags contains tag -%}
          {%- assign sharedTags = sharedTags | plus: 1 -%}
          {%- if sharedTags == minTags -%}{%- break -%}{%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if sharedTags < minTags -%}
        {% include post_title.html %}
        {% assign relatedCount = relatedCount | plus: 1 %}
        {%- if relatedCount == maxRelated -%}{%- break -%}{%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

<!-- If there still aren't enough, just pick recent posts from other categories,
as long as they don't have more than minTags shared tags -->
{%- if relatedCount < maxRelated -%}
  {%- for post in site.posts -%}
    {%- if relatedCount < maxRelated and page.url != post.url and page.category != post.category -%}
      {%- assign sharedTags = 0 -%}
      {%- for tag in post.tags -%}
        {%- if page.tags contains tag -%}
          {%- assign sharedTags = sharedTags | plus: 1 -%}
          {%- if sharedTags == minTags -%}{%- break -%}{%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if sharedTags < minTags -%}
        {% include post_title.html %}
        {% assign relatedCount = relatedCount | plus: 1 %}
        {%- if relatedCount == maxRelated -%}{%- break -%}{%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
