{%- if site.posts.size > 1 -%}
    <h2>Related posts</h2>
{%- endif -%}

{% comment %}
  Feel free to play with these
{% endcomment %}
{%- assign maxRelated = 3 -%}
{%- assign minTags = 2 -%}
{%- assign maxTags = 5 -%}

{% comment %}
  Probably don't play with anything after this point
{% endcomment %}
{%- assign relatedCount = 0 -%}

{% comment %}
  Working down from maxTags to minTags,
  look for posts with the specified number of tags in common.
{% endcomment %}
{%- for numTags in (minTags..maxTags) reversed -%}
  {%- for post in site.posts -%}
    {%- if relatedCount < maxRelated and page.url != post.url -%}
      {%- assign sharedTags = 0 -%}
      {%- for tag in post.tags -%}
        {%- if page.tags contains tag -%}
          {%- assign sharedTags = sharedTags | plus: 1 -%}
          {%- if sharedTags == numTags -%}
            {% include post_title.html %}
            {%- assign relatedCount = relatedCount | plus: 1 -%}
            {%- break -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if relatedCount == maxRelated -%}{%- break -%}{%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endfor -%}

{% comment %}
  If there aren't enough, pick recent posts from the same category,
  as long as they don't have more than minTags shared tags
{% endcomment %}
{%- if relatedCount < maxRelated -%}
  {%- for post in site.posts -%}
    {%- if relatedCount < maxRelated and page.url != post.url and page.category == post.category -%}
      {%- assign sharedTags = 0 -%}
      {%- for tag in post.tags -%}
        {%- if page.tags contains tag -%}
          {%- assign sharedTags = sharedTags | plus: 1 -%}
          {%- if sharedTags == minTags -%}{%- break -%}{%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if sharedTags < minTags -%}
        {% include post_title.html %}
        {% assign relatedCount = relatedCount | plus: 1 %}
        {%- if relatedCount == maxRelated -%}{%- break -%}{%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{% comment %}
  If there still aren't enough, just pick recent posts from other categories,
  as long as they don't have more than minTags shared tags
{% endcomment %}
{%- if relatedCount < maxRelated -%}
  {%- for post in site.posts -%}
    {%- if relatedCount < maxRelated and page.url != post.url and page.category != post.category -%}
      {%- assign sharedTags = 0 -%}
      {%- for tag in post.tags -%}
        {%- if page.tags contains tag -%}
          {%- assign sharedTags = sharedTags | plus: 1 -%}
          {%- if sharedTags == minTags -%}{%- break -%}{%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if sharedTags < minTags -%}
        {% include post_title.html %}
        {% assign relatedCount = relatedCount | plus: 1 %}
        {%- if relatedCount == maxRelated -%}{%- break -%}{%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
